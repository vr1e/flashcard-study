{% extends "base.html" %}
{% load static %}

{% block title %}Learning Buddy - Flashcard Study{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h1 class="mb-4">Learning Buddy</h1>

            <!-- Partnership Status -->
            <div id="partnership-status" class="card mb-4">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading partnership status...</p>
                </div>
            </div>

            <!-- Active Partnership View (hidden by default) -->
            <div id="active-partnership" class="card mb-4" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">Active Partnership</h5>
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-people-fill text-success me-3" style="font-size: 2rem;"></i>
                        <div>
                            <p class="mb-0"><strong>Partner:</strong> <span id="partner-username"></span></p>
                            <p class="mb-0 text-muted"><small>Since: <span id="partnership-date"></span></small></p>
                            <p class="mb-0 text-muted"><small>Shared Courses: <span id="shared-decks-count"></span></small></p>
                        </div>
                    </div>
                    <button id="dissolve-btn" class="btn btn-danger btn-sm">
                        <i class="bi bi-x-circle"></i> Dissolve Partnership
                    </button>
                </div>
            </div>

            <!-- No Partnership View (hidden by default) -->
            <div id="no-partnership" class="card mb-4" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">Create Partnership</h5>
                    <p class="text-muted">Partner with your learning buddy to share courses and learn together!</p>

                    <div class="mb-4">
                        <h6>Send Invitation</h6>
                        <p class="text-muted small">Generate a code to share with your partner</p>
                        <button id="generate-invite-btn" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Generate Invitation Code
                        </button>
                    </div>

                    <hr>

                    <div>
                        <h6>Accept Invitation</h6>
                        <p class="text-muted small">Enter a code you received from your partner</p>
                        <div class="input-group">
                            <input type="text" id="invite-code-input" class="form-control"
                                   placeholder="Enter 6-character code" maxlength="6"
                                   style="text-transform: uppercase;">
                            <button id="accept-invite-btn" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Accept
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invitation Display (hidden by default) -->
            <div id="invitation-display" class="card mb-4" style="display: none;">
                <div class="card-body text-center">
                    <h5 class="card-title">Your Invitation Code</h5>
                    <div class="my-4">
                        <div class="display-4 font-monospace text-primary" id="invitation-code"></div>
                    </div>
                    <p class="text-muted">Share this code with your partner</p>
                    <p class="text-muted small">Expires: <span id="invitation-expires"></span></p>
                    <button id="copy-code-btn" class="btn btn-outline-primary btn-sm me-2">
                        <i class="bi bi-clipboard"></i> Copy Code
                    </button>
                    <button id="cancel-invite-btn" class="btn btn-outline-secondary btn-sm">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Back to Dashboard -->
            <div class="text-center">
                <a href="{% url 'index' %}" class="btn btn-link">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
    import { api } from '{% static "js/api.js" %}';

    let currentPartnership = null;

    /**
     * Get user-friendly error message from API error code
     */
    function getErrorMessage(error) {
        // If error has a code property, map it to a user-friendly message
        if (error && error.error && error.error.code) {
            const errorCode = error.error.code;
            const errorMessages = {
                'ALREADY_PARTNERED': 'You already have an active partnership. Dissolve your current partnership first.',
                'INVALID_INPUT': 'Please enter a valid 6-character code.',
                'INVALID_CODE': 'This invitation code is not valid. Please check the code and try again.',
                'EXPIRED': 'This invitation has expired. Please ask your partner to generate a new code.',
                'SELF_INVITATION': 'You cannot accept your own invitation code.',
                'NO_PARTNERSHIP': 'No active partnership found.',
                'INVALID_JSON': 'Invalid request. Please try again.'
            };

            return errorMessages[errorCode] || error.error.message || 'An error occurred. Please try again.';
        }

        // Fallback to generic message
        return error && error.error && error.error.message
            ? error.error.message
            : 'An error occurred. Please try again.';
    }

    async function loadPartnershipStatus() {
        try {
            currentPartnership = await api.getPartnership();

            if (currentPartnership) {
                showActivePartnership();
            } else {
                showNoPartnership();
            }
        } catch (error) {
            console.error('Failed to load partnership:', error);
            document.getElementById('partnership-status').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load partnership status. Please refresh the page.
                </div>
            `;
        }
    }

    function showActivePartnership() {
        document.getElementById('partnership-status').style.display = 'none';
        document.getElementById('active-partnership').style.display = 'block';
        document.getElementById('no-partnership').style.display = 'none';

        document.getElementById('partner-username').textContent = currentPartnership.partner.username;
        document.getElementById('partnership-date').textContent =
            new Date(currentPartnership.created_at).toLocaleDateString();
        document.getElementById('shared-decks-count').textContent = currentPartnership.shared_decks_count;
    }

    function showNoPartnership() {
        document.getElementById('partnership-status').style.display = 'none';
        document.getElementById('active-partnership').style.display = 'none';
        document.getElementById('no-partnership').style.display = 'block';
    }

    async function generateInvitation() {
        try {
            const invitation = await api.createPartnershipInvite();

            document.getElementById('invitation-code').textContent = invitation.code;
            document.getElementById('invitation-expires').textContent =
                new Date(invitation.expires_at).toLocaleString();

            document.getElementById('no-partnership').style.display = 'none';
            document.getElementById('invitation-display').style.display = 'block';
        } catch (error) {
            console.error('Failed to create invitation:', error);
            alert(getErrorMessage(error));
        }
    }

    async function acceptInvitation() {
        const code = document.getElementById('invite-code-input').value.trim().toUpperCase();

        if (!code || code.length !== 6) {
            alert('Please enter a valid 6-character code');
            return;
        }

        try {
            await api.acceptPartnershipInvite(code);
            alert('Partnership created successfully!');
            window.location.reload();
        } catch (error) {
            console.error('Failed to accept invitation:', error);
            alert(getErrorMessage(error));
        }
    }

    async function dissolvePartnership() {
        if (!confirm('Are you sure you want to dissolve this partnership? Shared courses will become personal collections.')) {
            return;
        }

        try {
            await api.dissolvePartnership();
            alert('Partnership dissolved successfully');
            window.location.reload();
        } catch (error) {
            console.error('Failed to dissolve partnership:', error);
            alert(getErrorMessage(error));
        }
    }

    function copyCode() {
        const code = document.getElementById('invitation-code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            const btn = document.getElementById('copy-code-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        });
    }

    // Event listeners
    document.getElementById('generate-invite-btn').addEventListener('click', generateInvitation);
    document.getElementById('accept-invite-btn').addEventListener('click', acceptInvitation);
    document.getElementById('dissolve-btn').addEventListener('click', dissolvePartnership);
    document.getElementById('copy-code-btn').addEventListener('click', copyCode);
    document.getElementById('cancel-invite-btn').addEventListener('click', () => {
        document.getElementById('invitation-display').style.display = 'none';
        document.getElementById('no-partnership').style.display = 'block';
    });

    // Load on page ready
    loadPartnershipStatus();
</script>
{% endblock %}
